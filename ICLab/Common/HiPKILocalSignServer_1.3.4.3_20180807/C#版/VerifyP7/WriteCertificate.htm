<!DOCTYPE HTML>
<HTML>
<body  onload="myLoad()">
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" charset="utf-8"/> 
<script type="text/javascript" src="errorcode.js"></script>
<SCRIPT type="text/javascript">
var postTarget;
var timeoutId;
function postData(target,data)
{
	if(!http.sendRequest)
	{
		return null;
	}
	http.url=target;
	http.actionMethod="POST";
	var code=http.sendRequest(data);
	if(code!=0) return null;
	return http.responseText;

}
function setOutput(output)
{
	var ret=JSON.parse(output);
	if(ret.ret_code==0x76000031)
	{
		alert(window.location.hostname+"非信任網站，請先加入信任網站");
		return;
	}
	var slots = ret.slots;
	var selectSlot = document.getElementById('slotDescription');
	selectSlot.innerHTML="";
	for(var index in slots){ 
		if(slots[index].token instanceof Object){
			var opt = document.createElement('option');
			opt.value = slots[index].slotDescription;
			opt.innerHTML = slots[index].slotDescription+" 卡號:["+slots[index].token.serialNumber+"]";
			selectSlot.appendChild(opt);
		}
	}
}
function getImageInfo(ctx)
{
	var output="";
	for(i=0;i<2000;i++)
	{
		var data=ctx.getImageData(i,0,1,1).data;
		if(data[2]==0) break;
		output=output+String.fromCharCode(data[2],data[1],data[0]);
	}
	if(output=="") output='{"ret_code": 1979711501,"message": "執行檔錯誤或逾時"}';
	return output;
}
function myLoad(){
	var img = null;
	var ctx;
	var output="";
	var ua = window.navigator.userAgent;
	if(ua.indexOf("MSIE")==-1 && ua.indexOf("Trident")==-1) //not IE
	{
		img=document.createElement("img");
		img.crossOrigin = "Anonymous";
		img.src = 'http://localhost:61161/p11Image.bmp';
		var canvas = document.createElement("canvas");
		canvas.width=2000;canvas.height=1;
		ctx = canvas.getContext('2d');
		
		img.onload = function() {
			ctx.drawImage(img, 0, 0);
			output=getImageInfo(ctx);
			setOutput(output);
		};
		img.onerror = function()
		{
			document.getElementById('info').value= "未安裝客戶端程式或未啟動服務";
		};
	}else{
		document.getElementById("httpObject").innerHTML='<OBJECT id="http" width=1 height=1 style="LEFT: 1px; TOP: 1px" type="application/x-httpcomponent" VIEWASTEXT></OBJECT>';
		output=postData("http://localhost:61161/pkcs11info","");
		if(output==null){
			document.getElementById('info').value= "未安裝客戶端程式或未啟動服務";
			return;
		}else setOutput(output);
		
	}
	
}
function checkFinish(){
	if(postTarget){
		postTarget.close();
		alert("尚未安裝元件");
	}
}
function WriteCert()
{
    var ua = window.navigator.userAgent;
	if(ua.indexOf("MSIE")!=-1 || ua.indexOf("Trident")!=-1) //is IE, use ActiveX
	{
		postTarget=window.open("http://localhost:61161/waiting.gif", "Signing","height=200, width=200, left=100, top=20");
		var tbsPackage=getTbsPackage();
		document.getElementById("httpObject").innerHTML='<OBJECT id="http" width=1 height=1 style="LEFT: 1px; TOP: 1px" type="application/x-httpcomponent" VIEWASTEXT></OBJECT>';
		var data=postData("http://localhost:61161/writecert","tbsPackage="+tbsPackage);
		//console.log(data);
		postTarget.close();
		postTarget=null;
		if(!data) alert("尚未安裝元件");
		else WriteCertResult(data);
	}
	else{
		postTarget=window.open("http://localhost:61161/popupForm", "讀寫中","height=200, width=200, left=100, top=20");
		timeoutId=setTimeout(checkFinish,3500);
	}
}

function getTbsPackage(){
		var tbsData = {};
		var tbsData1 = {};
		var certA = {};	
		var certB = {}; 
		var certC = {}; 
		var certD = {};
		
		tbsData["func"]="writecert";
		tbsData["type"]="";//;document.getElementById("type").value;				
		tbsData1["slotDescription"]=document.getElementById("slotDescription").value;				
		tbsData1["pin"]=encodeURIComponent(document.getElementById("pin").value);				
		tbsData1["sopin"]=encodeURIComponent(document.getElementById("sopin").value);	
		certA["id"]=document.getElementById("id1").value;
		certA["label"]=document.getElementById("label1").value;
		certA["certb64"]=document.getElementById("certb64_1").value;
		certB["id"]=document.getElementById("id2").value;
		certB["label"]=document.getElementById("label2").value;
		certB["certb64"]=document.getElementById("certb64_2").value;
		certC["id"]=document.getElementById("id3").value;
		certC["label"]=document.getElementById("label3").value;
		certC["certb64"]=document.getElementById("certb64_3").value;
		certD["id"]=document.getElementById("id4").value;
		certD["label"]=document.getElementById("label4").value;
		certD["certb64"]=document.getElementById("certb64_4").value;		
		
		tbsData1["certs"]=[certA, certB, certC, certD];			
		tbsData["value"]=tbsData1;
		var json = JSON.stringify(tbsData);
		return json;
}
function WriteCertResult(data)
{
		var ret=JSON.parse(data);		
		document.getElementById("returnCode").value=ret.ret_code;
		if(ret.ret_code!=0){
			alert(MajorErrorReason(ret.ret_code));
			if(ret.last_error){
				alert(MinorErrorReason(ret.last_error));
			}
		}
}

function receiveMessage(event)
{
	if(console) console.debug(event);
	
	//安全起見，這邊應填入網站位址檢查
	if(event.origin!="http://localhost:61161")
		return;
	try{
		var ret = JSON.parse(event.data);
		if(ret.func=="getTbs"){
			clearTimeout(timeoutId);
			var json=getTbsPackage()
			postTarget.postMessage(json,"*");
		}else if(ret.func=="writecert"){
			WriteCertResult(event.data);
		}else{
			if(console) console.error("no func");
		}
	}catch(e){
		//errorhandle
		if(console) console.error(e);
	}
	
}
if (window.addEventListener) {
	window.addEventListener("message", receiveMessage, false);
	}else {
	//for IE8
		window.attachEvent("onmessage", receiveMessage);
	}
	//for IE8
var console=console||{"log":function(){}, "debug":function(){}, "error":function(){}};
</SCRIPT> 
</HEAD> 
<BODY>
<span id="httpObject" ></span>
<H1>寫新憑證範例</H1><br/>
type: <SELECT name="type" id="type"><OPTION value="NONE" selected>NONE</OPTION><!--<OPTION value="GPKIEncrypted" >GPKIEncrypted</OPTION>-->	   </SELECT><BR>
pin: <INPUT name="pin" id="pin" type="password" value="12345678"/><BR>
sopin: <INPUT name="sopin" id="sopin" type="password" value=""/><BR>
certs: <br/>
(注意：以下作業會先「清除」目前卡片「所有」的憑證，然後才開始依序寫入下面的憑證。<br/>
若有需要，建議測試前可先儲存您目前卡片內的所有憑證。)<br/>
cert:  id: <INPUT name="id1" id="id1" value="ROOTCACert"/> &nbsp;&nbsp; label: <INPUT name="label1" id="label1" value="ROOT CA Cert"/> &nbsp;&nbsp; certb64: <INPUT name="certb64_1" id="certb64_1" value="MIIFcjCCA1qgAwIBAgIQH51ZWtcvwgZEpYAIaeNe9jANBgkqhkiG9w0BAQUFADA/MQswCQYDVQQGEwJUVzEwMC4GA1UECgwnR292ZXJubWVudCBSb290IENlcnRpZmljYXRpb24gQXV0aG9yaXR5MB4XDTAyMTIwNTEzMjMzM1oXDTMyMTIwNTEzMjMzM1owPzELMAkGA1UEBhMCVFcxMDAuBgNVBAoMJ0dvdmVybm1lbnQgUm9vdCBDZXJ0aWZpY2F0aW9uIEF1dGhvcml0eTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAJoluOzMonWoe/fOW1mKydGGEghU7Jzy50b2iPN86aXfTEc2pBsBHH8eV4qNw8XRIePaJD9IK/ufLqGU5ywck9G/GwGHU5nOp/UKIXZ3/6m3xnOUT0b3EEk3+qhZSV1qgQdW8or5BtD3cCJNtLdBuTK4sfCxw5w/cP1T3YGq2GN49thTbqGsaoQkclSGxtKyyhwOeYHWtXBiCAEuTk8O1RGvqa/lmr/czIdtJuTJV6L7lvnM4T9TjGxMfptTCAtsF/tnyMKtsc2AtJfcdgEWFelq16TheEfOhtX7MfP6Mb40qij7cEwdScevLJ1tZqa2jWR+tSBqnTuBto9AAGdLiYa4zGX+FVPpBMHWXx1E1wovJ5pGfaENda1UhhXcSTvxls4Pm6Dso3pdvtUqdULle96ltqqvKKyskKw4t9VoNSZ63Pc78/1Fm9G7Q3hub/FCVGqY8A2tl+lSXunVanLeavcbYBT0peS2cWeqH+riTcFCQP5nRhc4L0c/cZyu5SHKYS1tB6iEfC3uUSXxY5Ce/eFXiGvviiNtsea9P63RPZYLhY3Naye7twWb7LuRqQoHEgKXTiCQ8P8NHuJBO9NAOueNXdpm5AKwB1KYXA6OM5zCppX7VRluTI6uSw+9wThNXo+EHWbNxWCWtFJaBYmOlXqYwZE8lSOyDvR5tMl8wUohAgMBAAGjajBoMB0GA1UdDgQWBBTMzO/MKWCkO7GStjz6MmKPrCUVOzAMBgNVHRMEBTADAQH/MDkGBGcqBwAEMTAvMC0CAQAwCQYFKw4DAhoFADAHBgVnKgMAAAQUA5vwIhP/lSg209yewDL7MTqKUWUwDQYJKoZIhvcNAQEFBQADggIBAECASvomyc5eMN1PhnR2WPWus4MzeKR6dBcZTulStbngCnRiqmjKeKBMmo4sIy7VahIkv9Ro04rQ2JyftB8M3jh+Vzj8jeJPXgyfqzvS/3WXy6TjZwj/5cAWtUgBfen5Cv8b5Wppv3ghqMKnI6mGq3ZW6A4M9hPdKmaKZEk9GhiHkASfQlK3T8v+R0F2Ne//AHY2RTKbxkaFXeIksB7jSJaYV0eUVXoPQbFEJPPB/hprv4j9wabak2BegUqZIJxIZhm1AHlUD7gsL0u8qV1bYH+Mh6XgUmMqvtg7hUAV/h62ZT/FS9p+tXo1KaMuephgIqP0fSdOLeq0dDzpD6QzDxARvBMB1uUO07+1EqLhRSPAzAhuYbeJq4PjJB7mXQfnHyA+z2fI56wwbSdLaG5LKlwCCDTb+HbkZ6MmnD+iMsJKxYEYMRBWqoTvLQr/uB930r+lWKBi5NdLkXWNiYCYfm3LU05er/ayl4WXudpVBrkk7tfGOB5jGxI7leFYrPLfhNVfmS8NVVvmONsuP3LpSIXLuykTjx44VbnzssQwmSNOXfJIoRIM3BKQCZBUkQM8R+XVyWXgt0t97EfTsws+rZ7QdAAO671RrcDeLMDDav7v3Aun+kbfYNucpllQdSNpc5Oy+fwC00fmcc4QAu4njIT/rEUNE1yDMuAlpYYsfPQS"/><br/>

cert:  id: <INPUT name="id2" id="id2" value="CACert"/> &nbsp;&nbsp; label: <INPUT name="label2" id="label2" value="CA Cert"/> &nbsp;&nbsp; certb64: <INPUT name="certb64_2" id="certb64_2" value="MIIFKzCCAxOgAwIBAgIRAPdCebq8ZyZr/T0luxlicNwwDQYJKoZIhvcNAQEFBQAwPzELMAkGA1UEBhMCVFcxMDAuBgNVBAoMJ0dvdmVybm1lbnQgUm9vdCBDZXJ0aWZpY2F0aW9uIEF1dGhvcml0eTAeFw0wMzAzMDMwNzAzMzJaFw0yMzAzMDMwNzAzMzJaMEoxCzAJBgNVBAYTAlRXMRIwEAYDVQQKDAnooYzmlL/pmaIxJzAlBgNVBAsMHuaUv+W6nOa4rOippuaGkeitieeuoeeQhuS4reW/gzCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAOMBE6x0/EA8Ufh/+VBrUD/ot97Idx+hClCeNoXH+Enx1H3mk6/gSkHw/rYHsWUE81xl38qlHSkCROmAQTDMVu8f0s9bUDHDG1BN8xw2CJsMtKCK+VGp3jic6ui7yQ0zNngU9aFMWG/rU00hWKQ7MkWSIPGHB3aQ0Oc1JeJ11V5EUKcE+/uoVPIw57nFy/ZIlgDvR+t5b/DP/2R7TAZGh9FwYfNNPDW85t33K8to35QMtddtNu8Mld20SUqb3AFKcp1cqWcPs2BgDaNnFyOjoaAgA9AOzJnUK/USrOzYyPo2PeXMjFXnXUrMCJz6wdGBba2Rsi8SO9BWkURvZUORy1cCAwEAAaOCARUwggERMB8GA1UdIwQYMBaAFMzM78wpYKQ7sZK2PPoyYo+sJRU7MB0GA1UdDgQWBBRL9kp3aNOUxOO1YNwOG++punv2UzAOBgNVHQ8BAf8EBAMCAQYwFAYDVR0gBA0wCzAJBgdghnZlAAMAMBIGA1UdEwEB/wQIMAYBAf8CAQAwPQYDVR0fBDYwNDAyoDCgLoYsaHR0cDovL2dyY2EubmF0Lmdvdi50dy9yZXBvc2l0b3J5L0NSTC9DQS5jcmwwVgYIKwYBBQUHAQEESjBIMEYGCCsGAQUFBzAChjpodHRwOi8vZ3JjYS5uYXQuZ292LnR3L3JlcG9zaXRvcnkvQ2VydHMvSXNzdWVkVG9UaGlzQ0EucDdiMA0GCSqGSIb3DQEBBQUAA4ICAQA/nasMIdJzUDIhDR9oCB57rz0c6YfHVI0+PdE3LxtjdKZFsiTPFQc/KE1jv62p08MIFK6v7hDcG+Rywn5oyNGWVmKOgsJDV6mpevIxJ9++UaGls7QQ38jsJ0RDes7LCyxHDQVM0q7nYA9gMCBF0TCAer5sD8JwWHkJRllVtxel+ROco0op6WpFN56juWIMNzeFOXFR2JaS1Hga1qiTaD07lF3TwoE3DQs1CSxOTTLbYYyNcWvFrFOQvwwU0TDnBZg8oaRASnlyQ1U3X0pLBOm8RbkatQYyShTccX9xbwFiNae0mMHD49l1d8SH8ceq6WhSK+60pFTM0UIb9Vw7SNhU/tkxO1wTVAcHKbaOxws2UqRoXaiaCs6evuna9arDLCGUCWwHxfb+kWTjQefuw51KfiQTKv5JY4Tqe7QPLibw5JNmwYYK2SeSAbA1Zpq298fAGJbYNDOX3/n/tI8Ysh5JZrVbvYNSQEKMPpmV3OecRNmGy+2EPbHbNQaFPrJe3ku/0baB9+lt7LkXocbIstH2Kqdyn/FGeGXRe26fQkLvJYqM/hcFx/a0EgadW47RUjKVPErsMpLmKFcIskzwEpR82NwLc2Gg5UGCixYqrBGFdoIdSQii7RglKiqUouTJlpR31tM0Zy5GFjBNKkRQoAz3jP/viuaKn+4JLXJO6Kpf1Q=="/><br/>

cert:  id: <INPUT name="id3" id="id3" value="SIGN"/> &nbsp;&nbsp; label: <INPUT name="label3" id="label3" value="cert1"/> &nbsp;&nbsp; certb64: <INPUT name="certb64_3" id="certb64_3" value=""/><br/>

cert:  id: <INPUT name="id4" id="id4" value="KEYX"/> &nbsp;&nbsp; label: <INPUT name="label4" id="label4" value="cert2"/> &nbsp;&nbsp; certb64: <INPUT name="certb64_4" id="certb64_4" value=""/><br/>

可用讀卡機：
<select name="slotDescription" id="slotDescription"></select><br/>
<INPUT id="WriteCert" type="button" value="寫憑證" onclick="WriteCert()"/> <br/>

<!--<FORM name="SignatureForm" action="VerifyPKCS1.jsp" method="POST"> -->
returnCode:<input type="text" name="returnCode" id="returnCode"/><br/>
<!--<input type="submit" name="submit" value="驗證"/><br/>-->
<br/>
<!--
輸入資料格式說明<br/>
{<br/>
&nbsp;&nbsp;        type:"GPKIEncrypted",<br/>
&nbsp;&nbsp;        value:"xxx"<br/>
}<br/>
<br/>
type=""時，value=未被base64的下述內容A<br/>
type="GPKIEncrypted", value=GPKI專用對稱式加密(Base64(下述內容A))<br/>
<br/>
A=<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;        slotDescription:"",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;        pin:"",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;        sopin:"",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;        certs:[<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                {id:"",label:"",certb64:""},<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                {id:"",label:"",certb64:""}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;        ]<br/>
&nbsp;&nbsp;}<br/>
-->
</FORM>
</BODY></HTML>
